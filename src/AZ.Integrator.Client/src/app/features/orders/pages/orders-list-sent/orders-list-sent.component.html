<div *ngIf="(selectedStore$ | async) === null" class="no-store-selected">
  <mat-card class="info-card">
    <mat-card-content>
      <div class="flex flex-col items-center gap-4 py-8">
        <mat-icon class="!text-6xl !h-16 !w-16 text-slate-400">store</mat-icon>
        <h2 class="text-xl font-semibold text-slate-700">Wybierz sklep</h2>
        <p class="text-slate-600 text-center max-w-md">
          Aby wyświetlić zamówienia, wybierz sklep z listy rozwijanej w filtrach powyżej.
        </p>
      </div>
    </mat-card-content>
  </mat-card>
</div>

<app-scroll-table
  *ngIf="selectedStore$ | async"
  [totalItems]="(totalItems$ | async)!"
  [currentPage]="(currentPage$ | async)!"
  [pageSize]="(pageSize$ | async)!"
  (page)="pageChanged($event)">
  <table mat-table [dataSource]="(orders$ | async)!">
    <ng-container matColumnDef="shipmentNumber">
      <th mat-header-cell *matHeaderCellDef>Numer przesyłki</th>
      <td mat-cell *matCellDef="let order">
        <div class="flex items-center gap-2">
          <span class="font-semibold" *ngIf="getShipmentNumber(order) | async">
            {{ getShipmentNumber(order) | async }}
          </span>
          <div *ngIf="(getShipmentNumber(order) | async) === undefined" class="flex items-center gap-2">
            <mat-icon class="!text-red-600">close</mat-icon>
            <span class="!text-red-600">Brak</span>
          </div>
        </div>
      </td>
    </ng-container>

    <ng-container matColumnDef="invoiceNumber">
      <th mat-header-cell *matHeaderCellDef>Numer faktury</th>
      <td mat-cell *matCellDef="let order">
        <div class="flex items-center gap-2">
          <span class="font-semibold" *ngIf="getInvoiceNumber(order) | async">
            {{ getInvoiceNumber(order) | async }}
          </span>
          <div *ngIf="(getInvoiceNumber(order) | async) === undefined" class="flex items-center gap-2">
            <mat-icon class="!text-red-600">close</mat-icon>
            <span class="!text-red-600">Brak</span>
          </div>
        </div>
      </td>
    </ng-container>

    <ng-container matColumnDef="boughtAt">
      <th mat-header-cell *matHeaderCellDef>Data zakupu</th>
      <td mat-cell *matCellDef="let order">
        <div class="flex flex-col gap-1">
          <span class="font-semibold">{{ order.updatedAt | date: 'dd.MM.yyyy' }}</span>
          <span class="text-xs text-gray-500">{{ order.updatedAt | date: 'HH:mm:ss' }}</span>
        </div>
      </td>
    </ng-container>

    <ng-container matColumnDef="buyer">
      <th mat-header-cell *matHeaderCellDef>Dane kupującego</th>
      <td mat-cell *matCellDef="let order">
        <div class="flex flex-col gap-1">
          <span class="font-semibold">{{ order.buyer.firstName }} {{ order.buyer.lastName }}</span>
          <span class="text-xs text-gray-500">{{ order.buyer.login }}</span>
        </div>
      </td>
    </ng-container>

    <ng-container matColumnDef="deliveryType">
      <th mat-header-cell *matHeaderCellDef>Sposób dostawy</th>
      <td mat-cell *matCellDef="let order">
        <span class="px-3 py-1 bg-purple-100 text-purple-800 rounded-full text-sm">
          {{ order?.delivery?.method?.name }}
        </span>
      </td>
    </ng-container>

    <ng-container matColumnDef="lineItems">
      <th mat-header-cell *matHeaderCellDef>Przedmioty</th>
      <td mat-cell *matCellDef="let order">
        <div class="flex flex-col gap-1">
          <div *ngFor="let item of order.lineItems" class="text-sm">
            {{ item.offer.name }}
          </div>
          <div *ngIf="order.messageToSeller" class="flex items-center gap-2 mt-2 mb-2 p-2 bg-blue-50 rounded">
            <mat-icon class="!text-blue-500 !text-sm !h-4 !w-4">info</mat-icon>
            <span class="text-xs text-gray-600">{{ order.messageToSeller }}</span>
          </div>
        </div>
      </td>
    </ng-container>

    <ng-container matColumnDef="quantity">
      <th mat-header-cell *matHeaderCellDef>Ilość</th>
      <td mat-cell *matCellDef="let order">
        <div class="flex flex-col gap-1">
          <span
            *ngFor="let item of order.lineItems"
            class="px-2 py-1 bg-gray-100 text-gray-800 rounded text-sm text-center">
            {{ item.quantity }}
          </span>
        </div>
      </td>
    </ng-container>

    <ng-container matColumnDef="price">
      <th mat-header-cell *matHeaderCellDef>Wartość brutto</th>
      <td mat-cell *matCellDef="let order">
        <div class="flex flex-col gap-1">
          <span *ngFor="let item of order.lineItems" class="text-sm">
            {{ item.price.amount * item.quantity | number: '1.2-2' }} {{ item.price.currency }}
          </span>
        </div>
      </td>
    </ng-container>

    <ng-container matColumnDef="actions">
      <th mat-header-cell *matHeaderCellDef>Akcje</th>
      <td mat-cell *matCellDef="let order">
        <div class="flex gap-2">
          <ng-container *ngIf="canGenerateShipmentLabel(order) | async">
            <button
              mat-icon-button
              matTooltip="Pobierz list przewozowy"
              (click)="generateShipmentLabel(order); $event.stopPropagation()">
              <mat-icon class="!text-red-600">picture_as_pdf</mat-icon>
            </button>
          </ng-container>

          <ng-container *ngIf="canGenerateInvoice(order) | async">
            <button
              mat-icon-button
              matTooltip="Wygeneruj fakturę"
              (click)="generateInvoice(order); $event.stopPropagation()">
              <mat-icon class="!text-blue-600">receipt_long</mat-icon>
            </button>
          </ng-container>

          <ng-container *ngIf="canDownloadInvoice(order) | async">
            <button
              mat-icon-button
              matTooltip="Pobierz fakturę"
              (click)="downloadInvoice(order); $event.stopPropagation()">
              <mat-icon class="!text-blue-600">download</mat-icon>
            </button>
          </ng-container>
        </div>
      </td>
    </ng-container>

    <tr mat-header-row *matHeaderRowDef="displayedColumns" class="!bg-gray-300"></tr>
    <tr mat-row *matRowDef="let row; columns: displayedColumns" class="hover:bg-gray-200"></tr>
  </table>
</app-scroll-table>
