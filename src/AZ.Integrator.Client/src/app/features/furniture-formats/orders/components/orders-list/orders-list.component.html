<app-scroll-table
  [totalItems]="(totalItems$ | async)!"
  [currentPage]="(currentPage$ | async)!"
  [pageSize]="(pageSize$ | async)!"
  (page)="pageChanged($event)">
  <table mat-table [dataSource]="(orders$ | async) || []" multiTemplateDataRows class="w-full">
    <!-- Expand Column -->
    <ng-container matColumnDef="expand">
      <th mat-header-cell *matHeaderCellDef aria-label="row actions" class="w-8 px-0">&nbsp;</th>
      <td mat-cell *matCellDef="let order" class="w-12">
        <button mat-icon-button (click)="toggleRow(order)" type="button">
          <mat-icon>{{ expandedOrder?.id === order.id ? 'expand_less' : 'expand_more' }}</mat-icon>
        </button>
      </td>
    </ng-container>

    <!-- ID Column -->
    <ng-container matColumnDef="id">
      <th mat-header-cell *matHeaderCellDef class="table-header">ID</th>
      <td mat-cell *matCellDef="let order">{{ order.id }}</td>
    </ng-container>

    <!-- Number Column -->
    <ng-container matColumnDef="number">
      <th mat-header-cell *matHeaderCellDef class="table-header">Numer zamówienia</th>
      <td mat-cell *matCellDef="let order">
        <span class="font-semibold">{{ order.number }}</span>
      </td>
    </ng-container>

    <!-- Created At Column -->
    <ng-container matColumnDef="createdAt">
      <th mat-header-cell *matHeaderCellDef class="table-header">Data utworzenia</th>
      <td mat-cell *matCellDef="let order">
        {{ order.createdAt | date: 'dd.MM.yyyy HH:mm' }}
      </td>
    </ng-container>

    <!-- Status Column -->
    <ng-container matColumnDef="status">
      <th mat-header-cell *matHeaderCellDef class="table-header">Status</th>
      <td mat-cell *matCellDef="let order">
        <span [class]="getStatusClass(order.status)" class="status-badge">
          {{ getStatusDisplay(order.status) }}
        </span>
      </td>
    </ng-container>

    <!-- Supplier Column -->
    <ng-container matColumnDef="supplier">
      <th mat-header-cell *matHeaderCellDef class="table-header">Dostawca</th>
      <td mat-cell *matCellDef="let order">
        {{ getSupplierName(order.supplierId) }}
      </td>
    </ng-container>

    <!-- Expanded Content -->
    <ng-container matColumnDef="expandedDetail">
      <td mat-cell *matCellDef="let order" [attr.colspan]="displayedColumns.length" class="expanded-cell">
        <div class="order-detail" [@detailExpand]="order?.id === expandedOrder?.id ? 'expanded' : 'collapsed'">
          <div class="detail-content">
            <h3 class="detail-title">Szczegóły zamówienia</h3>

            <!-- Additional Notes Section -->
            <div class="additional-notes-section" *ngIf="order.additionalNotes">
              <div class="notes-header">
                <mat-icon>note</mat-icon>
                <h4>Dodatkowe uwagi</h4>
              </div>
              <div class="notes-content">
                {{ order.additionalNotes }}
              </div>
            </div>

            <div class="furniture-lines" *ngIf="order.furnitureLines && order.furnitureLines.length > 0">
              <div *ngFor="let furnitureLine of order.furnitureLines" class="furniture-line-card">
                <div class="furniture-line-header">
                  <h4>Mebel: {{ furnitureLine.furnitureCode }} (v{{ furnitureLine.furnitureVersion }})</h4>
                  <span class="quantity-badge">Ilość: {{ furnitureLine.quantityOrdered }}</span>
                </div>

                <div class="part-lines-table" *ngIf="furnitureLine.partLines && furnitureLine.partLines.length > 0">
                  <table class="parts-table">
                    <thead>
                      <tr>
                        <th>Nazwa formatki</th>
                        <th>Długość (mm)</th>
                        <th>Szerokość (mm)</th>
                        <th>Grubość (mm)</th>
                        <th>Oklejka długość</th>
                        <th>Oklejka szerokość</th>
                        <th>Ilość</th>
                        <th>Dodatkowe info</th>
                      </tr>
                    </thead>
                    <tbody>
                      <tr *ngFor="let part of furnitureLine.partLines">
                        <td>{{ part.name }}</td>
                        <td>{{ part.dimensions.lengthMm }}</td>
                        <td>{{ part.dimensions.widthMm }}</td>
                        <td>{{ part.dimensions.thicknessMm }}</td>
                        <td>{{ getEdgeBandingTypeDisplay(part.dimensions.lengthEdgeBandingType) }}</td>
                        <td>{{ getEdgeBandingTypeDisplay(part.dimensions.widthEdgeBandingType) }}</td>
                        <td>{{ part.quantity }}</td>
                        <td>{{ part.additionalInfo || '-' }}</td>
                      </tr>
                    </tbody>
                  </table>
                </div>
                <div *ngIf="!furnitureLine.partLines || furnitureLine.partLines.length === 0" class="no-parts">
                  <p>Brak formatek w tej linii</p>
                </div>
              </div>
            </div>
            <div *ngIf="!order.furnitureLines || order.furnitureLines.length === 0" class="no-furniture">
              <p>Brak linii mebli w tym zamówieniu</p>
            </div>
          </div>
        </div>
      </td>
    </ng-container>

    <tr mat-header-row *matHeaderRowDef="displayedColumns" class="!bg-gray-300"></tr>
    <tr mat-row *matRowDef="let row; columns: displayedColumns" class="table-row"></tr>
    <tr mat-row *matRowDef="let row; columns: ['expandedDetail']" class="detail-row"></tr>
  </table>
</app-scroll-table>
