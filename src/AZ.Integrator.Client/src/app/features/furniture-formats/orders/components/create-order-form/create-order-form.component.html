<div class="create-order-container">
  <div class="header">
    <h2 class="title">Nowe zamówienie formatek mebli</h2>
  </div>

  <form [formGroup]="orderForm" class="order-form">
    <mat-stepper [linear]="true" #stepper>
      <!-- Step 1: Supplier Selection -->
      <mat-step [stepControl]="orderForm.get('supplierId')!">
        <ng-template matStepLabel>Wybór dostawcy</ng-template>
        <mat-card class="step-card">
          <mat-card-header>
            <mat-card-title>Wybierz dostawcę</mat-card-title>
          </mat-card-header>
          <mat-card-content>
            <mat-form-field appearance="outline" class="full-width">
              <mat-label>Dostawca</mat-label>
              <mat-select formControlName="supplierId" required>
                @for (supplier of suppliers$ | async; track supplier) {
                  <mat-option [value]="supplier.id">
                    {{ supplier.name }}
                  </mat-option>
                }
              </mat-select>
              @if (orderForm.get('supplierId')?.hasError('required')) {
                <mat-error> Dostawca jest wymagany </mat-error>
              }
            </mat-form-field>
          </mat-card-content>
        </mat-card>
        <div class="step-actions">
          <button mat-raised-button type="button" (click)="onCancel()">Anuluj</button>
          <button
            mat-raised-button
            color="primary"
            type="button"
            matStepperNext
            [disabled]="!orderForm.get('supplierId')?.valid">
            Dalej
          </button>
        </div>
      </mat-step>

      <!-- Step 2: Furniture Selection -->
      <mat-step>
        <ng-template matStepLabel>Wybór mebli</ng-template>
        <mat-card class="step-card">
          <mat-card-header>
            <mat-card-title>Wybierz definicje mebli</mat-card-title>
          </mat-card-header>
          <mat-card-content>
            <app-furniture-selector
              [furnitureDefinitions]="furnitureDefinitions$ | async"
            (selectionChange)="onFurnitureSelectionChange($event)"></app-furniture-selector>
          </mat-card-content>
        </mat-card>
        <div class="step-actions">
          <button mat-button type="button" matStepperPrevious>Wstecz</button>
          <button
            mat-raised-button
            color="primary"
            type="button"
            matStepperNext
            [disabled]="furnitureLines.length === 0">
            Dalej
          </button>
        </div>
      </mat-step>

      <!-- Step 3: Furniture Lines Details -->
      <mat-step>
        <ng-template matStepLabel>Formatki mebli</ng-template>
        @if (furnitureLines.length > 0) {
          <div class="furniture-lines-section">
            @for (furnitureLine of furnitureLines.controls; track furnitureLine; let i = $index) {
              <div
                [formGroup]="furnitureLine"
                class="furniture-line-card">
                <mat-card>
                  <mat-card-header>
                    <mat-card-title> Mebel: {{ getFurnitureDefinitionDisplay(furnitureLine) }} </mat-card-title>
                  </mat-card-header>
                  <mat-card-content>
                    <!-- Quantity Ordered -->
                    <div class="quantity-section">
                      <mat-form-field appearance="outline">
                        <mat-label>Ilość zamówionych mebli</mat-label>
                        <input matInput type="number" formControlName="quantityOrdered" min="1" />
                        @if (furnitureLine.get('quantityOrdered')?.hasError('required')) {
                          <mat-error>
                            Ilość jest wymagana
                          </mat-error>
                        }
                        @if (furnitureLine.get('quantityOrdered')?.hasError('min')) {
                          <mat-error>
                            Ilość musi być większa niż 0
                          </mat-error>
                        }
                      </mat-form-field>
                    </div>
                    <!-- Part Lines -->
                    <div class="part-lines-section">
                      <div class="part-lines-header">
                        <h4>Formatki</h4>
                        <button
                          mat-raised-button
                          color="primary"
                          type="button"
                          (click)="addPartLine(i)"
                          class="add-part-button">
                          <mat-icon>add</mat-icon>
                          Dodaj formatkę
                        </button>
                      </div>
                      <div formArrayName="partLines" class="part-lines-list">
                        @for (partLine of getPartLines(i).controls; track partLine; let j = $index) {
                          <mat-card
                            [id]="'part-line-' + i + '-' + j"
                            [formGroup]="partLine"
                            class="part-line-card">
                            <mat-card-content>
                              <div class="part-line-actions">
                                <button
                                  mat-icon-button
                                  color="warn"
                                  type="button"
                                  (click)="removePartLine(i, j)"
                                  matTooltip="Usuń formatkę">
                                  <mat-icon>delete</mat-icon>
                                </button>
                              </div>
                              <div class="part-line-fields">
                                <mat-form-field appearance="outline">
                                  <mat-label>Nazwa formatki</mat-label>
                                  <input matInput formControlName="partName" />
                                  @if (partLine.get('partName')?.hasError('required')) {
                                    <mat-error>
                                      Nazwa jest wymagana
                                    </mat-error>
                                  }
                                </mat-form-field>
                                <mat-form-field appearance="outline">
                                  <mat-label>Długość (mm)</mat-label>
                                  <input matInput type="number" formControlName="lengthMm" min="1" />
                                  @if (partLine.get('lengthMm')?.hasError('required')) {
                                    <mat-error>
                                      Długość jest wymagana
                                    </mat-error>
                                  }
                                </mat-form-field>
                                <mat-form-field appearance="outline">
                                  <mat-label>Szerokość (mm)</mat-label>
                                  <input matInput type="number" formControlName="widthMm" min="1" />
                                  @if (partLine.get('widthMm')?.hasError('required')) {
                                    <mat-error>
                                      Szerokość jest wymagana
                                    </mat-error>
                                  }
                                </mat-form-field>
                                <mat-form-field appearance="outline">
                                  <mat-label>Grubość (mm)</mat-label>
                                  <input matInput type="number" formControlName="thicknessMm" min="1" />
                                  @if (partLine.get('thicknessMm')?.hasError('required')) {
                                    <mat-error>
                                      Grubość jest wymagana
                                    </mat-error>
                                  }
                                </mat-form-field>
                                <mat-form-field appearance="outline">
                                  <mat-label>Oklejka długość</mat-label>
                                  <mat-select formControlName="lengthEdgeBandingType">
                                    @for (type of edgeBandingTypes; track type) {
                                      <mat-option [value]="type">
                                        {{ getEdgeBandingTypeDisplay(type) }}
                                      </mat-option>
                                    }
                                  </mat-select>
                                </mat-form-field>
                                <mat-form-field appearance="outline">
                                  <mat-label>Oklejka szerokość</mat-label>
                                  <mat-select formControlName="widthEdgeBandingType">
                                    @for (type of edgeBandingTypes; track type) {
                                      <mat-option [value]="type">
                                        {{ getEdgeBandingTypeDisplay(type) }}
                                      </mat-option>
                                    }
                                  </mat-select>
                                </mat-form-field>
                                <mat-form-field appearance="outline">
                                  <mat-label>Ilość</mat-label>
                                  <input matInput type="number" formControlName="quantity" min="1" />
                                  @if (partLine.get('quantity')?.hasError('required')) {
                                    <mat-error>
                                      Ilość jest wymagana
                                    </mat-error>
                                  }
                                </mat-form-field>
                                <mat-form-field appearance="outline" class="full-width">
                                  <mat-label>Dodatkowe informacje</mat-label>
                                  <textarea matInput formControlName="additionalInfo" rows="2"></textarea>
                                </mat-form-field>
                              </div>
                            </mat-card-content>
                          </mat-card>
                        }
                      </div>
                    </div>
                  </mat-card-content>
                </mat-card>
              </div>
            }
          </div>
        }
        <div class="step-actions">
          <button mat-button type="button" matStepperPrevious>Wstecz</button>
          <button
            mat-raised-button
            color="primary"
            type="button"
            matStepperNext
            [disabled]="!orderForm.valid || furnitureLines.length === 0">
            Dalej
          </button>
        </div>
      </mat-step>

      <!-- Step 4: Additional Notes -->
      <mat-step>
        <ng-template matStepLabel>Dodatkowe informacje</ng-template>
        <mat-card class="step-card">
          <mat-card-header>
            <mat-card-title>Dodatkowe uwagi do zamówienia</mat-card-title>
            <mat-card-subtitle>Wpisz dodatkowe informacje, które zostaną dołączone do maila</mat-card-subtitle>
          </mat-card-header>
          <mat-card-content>
            <mat-form-field appearance="outline" class="full-width">
              <mat-label>Dodatkowe uwagi</mat-label>
              <textarea
                matInput
                formControlName="additionalNotes"
                rows="8"
              placeholder="Wpisz tutaj dodatkowe informacje lub uwagi do zamówienia..."></textarea>
            </mat-form-field>
          </mat-card-content>
        </mat-card>
        <div class="step-actions">
          <button mat-button type="button" matStepperPrevious>Wstecz</button>
          <button
            mat-raised-button
            color="primary"
            type="button"
            (click)="onSubmit()"
            [disabled]="!orderForm.valid || furnitureLines.length === 0">
            Utwórz zamówienie
          </button>
        </div>
      </mat-step>
    </mat-stepper>
  </form>
</div>
