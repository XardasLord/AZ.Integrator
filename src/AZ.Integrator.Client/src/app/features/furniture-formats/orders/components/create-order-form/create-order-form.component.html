<div class="create-order-container">
  <div class="header">
    <h2 class="title">Nowe zamówienie formatek mebli</h2>
  </div>

  <form [formGroup]="orderForm" (ngSubmit)="onSubmit()" class="order-form">
    <!-- Supplier Selection -->
    <mat-card class="form-section">
      <mat-card-header>
        <mat-card-title>Dostawca</mat-card-title>
      </mat-card-header>
      <mat-card-content>
        <mat-form-field appearance="outline" class="full-width">
          <mat-label>Wybierz dostawcę</mat-label>
          <mat-select formControlName="supplierId" required>
            <mat-option *ngFor="let supplier of suppliers$ | async" [value]="supplier.id">
              {{ supplier.name }}
            </mat-option>
          </mat-select>
          <mat-error *ngIf="orderForm.get('supplierId')?.hasError('required')"> Dostawca jest wymagany </mat-error>
        </mat-form-field>
      </mat-card-content>
    </mat-card>

    <!-- Furniture Selection -->
    <mat-card class="form-section">
      <mat-card-header>
        <mat-card-title>Definicje mebli</mat-card-title>
      </mat-card-header>
      <mat-card-content>
        <app-furniture-selector
          [furnitureDefinitions]="furnitureDefinitions$ | async"
          (selectionChange)="onFurnitureSelectionChange($event)"></app-furniture-selector>
      </mat-card-content>
    </mat-card>

    <!-- Furniture Lines -->
    <div *ngIf="furnitureLines.length > 0" class="furniture-lines-section">
      <div
        *ngFor="let furnitureLine of furnitureLines.controls; let i = index"
        [formGroup]="furnitureLine"
        class="furniture-line-card">
        <mat-card>
          <mat-card-header>
            <mat-card-title> Mebel: {{ getFurnitureDefinitionDisplay(furnitureLine) }} </mat-card-title>
          </mat-card-header>
          <mat-card-content>
            <!-- Quantity Ordered -->
            <div class="quantity-section">
              <mat-form-field appearance="outline">
                <mat-label>Ilość zamówionych mebli</mat-label>
                <input matInput type="number" formControlName="quantityOrdered" min="1" />
                <mat-error *ngIf="furnitureLine.get('quantityOrdered')?.hasError('required')">
                  Ilość jest wymagana
                </mat-error>
                <mat-error *ngIf="furnitureLine.get('quantityOrdered')?.hasError('min')">
                  Ilość musi być większa niż 0
                </mat-error>
              </mat-form-field>
            </div>

            <!-- Part Lines -->
            <div class="part-lines-section">
              <div class="part-lines-header">
                <h4>Formatki</h4>
                <button
                  mat-raised-button
                  color="primary"
                  type="button"
                  (click)="addPartLine(i)"
                  class="add-part-button">
                  <mat-icon>add</mat-icon>
                  Dodaj formatkę
                </button>
              </div>

              <div formArrayName="partLines" class="part-lines-list">
                <mat-card
                  [id]="'part-line-' + i + '-' + j"
                  *ngFor="let partLine of getPartLines(i).controls; let j = index"
                  [formGroup]="partLine"
                  class="part-line-card">
                  <mat-card-content>
                    <div class="part-line-actions">
                      <button
                        mat-icon-button
                        color="warn"
                        type="button"
                        (click)="removePartLine(i, j)"
                        matTooltip="Usuń formatkę">
                        <mat-icon>delete</mat-icon>
                      </button>
                    </div>

                    <div class="part-line-fields">
                      <mat-form-field appearance="outline">
                        <mat-label>Nazwa formatki</mat-label>
                        <input matInput formControlName="partName" />
                        <mat-error *ngIf="partLine.get('partName')?.hasError('required')">
                          Nazwa jest wymagana
                        </mat-error>
                      </mat-form-field>

                      <mat-form-field appearance="outline">
                        <mat-label>Długość (mm)</mat-label>
                        <input matInput type="number" formControlName="lengthMm" min="1" />
                        <mat-error *ngIf="partLine.get('lengthMm')?.hasError('required')">
                          Długość jest wymagana
                        </mat-error>
                      </mat-form-field>

                      <mat-form-field appearance="outline">
                        <mat-label>Szerokość (mm)</mat-label>
                        <input matInput type="number" formControlName="widthMm" min="1" />
                        <mat-error *ngIf="partLine.get('widthMm')?.hasError('required')">
                          Szerokość jest wymagana
                        </mat-error>
                      </mat-form-field>

                      <mat-form-field appearance="outline">
                        <mat-label>Grubość (mm)</mat-label>
                        <input matInput type="number" formControlName="thicknessMm" min="1" />
                        <mat-error *ngIf="partLine.get('thicknessMm')?.hasError('required')">
                          Grubość jest wymagana
                        </mat-error>
                      </mat-form-field>

                      <mat-form-field appearance="outline">
                        <mat-label>Oklejka długość</mat-label>
                        <mat-select formControlName="lengthEdgeBandingType">
                          <mat-option *ngFor="let type of edgeBandingTypes" [value]="type">
                            {{ getEdgeBandingTypeDisplay(type) }}
                          </mat-option>
                        </mat-select>
                      </mat-form-field>

                      <mat-form-field appearance="outline">
                        <mat-label>Oklejka szerokość</mat-label>
                        <mat-select formControlName="widthEdgeBandingType">
                          <mat-option *ngFor="let type of edgeBandingTypes" [value]="type">
                            {{ getEdgeBandingTypeDisplay(type) }}
                          </mat-option>
                        </mat-select>
                      </mat-form-field>

                      <mat-form-field appearance="outline">
                        <mat-label>Ilość</mat-label>
                        <input matInput type="number" formControlName="quantity" min="1" />
                        <mat-error *ngIf="partLine.get('quantity')?.hasError('required')">
                          Ilość jest wymagana
                        </mat-error>
                      </mat-form-field>

                      <mat-form-field appearance="outline" class="full-width">
                        <mat-label>Dodatkowe informacje</mat-label>
                        <textarea matInput formControlName="additionalInfo" rows="2"></textarea>
                      </mat-form-field>
                    </div>
                  </mat-card-content>
                </mat-card>
              </div>
            </div>
          </mat-card-content>
        </mat-card>
      </div>
    </div>

    <!-- Form Actions -->
    <div class="form-actions">
      <button mat-raised-button type="button" (click)="onCancel()">Anuluj</button>
      <button
        mat-raised-button
        color="primary"
        type="submit"
        [disabled]="!orderForm.valid || furnitureLines.length === 0">
        Utwórz zamówienie
      </button>
    </div>
  </form>
</div>
